<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Página de Bienvenida</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/bienvenida.css">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
</head>

<div class="container">
  <div class="mt-5 pt-5 text-center" data-aos="fade-down" data-aos-duration="2300">
    <img src="assets/img/logos/lg-2.png" alt="Logo" class="bienvenida-logo">
  </div>

  <div class="pt-2 text-center" data-aos="fade-down" data-aos-duration="2300">
    <h1 class="titulo">¡Bienvenid@, <span id="username">Usuario</span>!</h1>
    <p class="mt-3 descripcion">Nos alegra tenerte aquí.</p>
  </div>

  <div id="qr-container" class="text-center my-4" data-aos="fade-down" data-aos-duration="2400"></div>

  <div class="text-center my-5" data-aos="fade-down" data-aos-duration="2400">
    <button id="btnEscanear" class="btn-custom">Ir al Escáner</button>
  </div>

  <div id="seccionEscaner" class="seccion-oculta my-5 text-white" style="display: none;" data-aos="fade-down"
    data-aos-duration="2400">
    <div class="text-center text-white">
      <h2>Bienvenido al Escáner</h2>
      <p>Aquí puedes escanear tus documentos.</p>
    </div>
  </div>

  <div id="qr-reader" class="text-center my-4" style="width: 300px; margin: 0 auto; display: none;"></div>
  <div id="qr-reader-results" class="text-center text-success fw-bold fs-5"></div>


  <div id="escannerSection" class="d-none">
    <h3 class="text-center">Escáner</h3>
    <div class="alert alert-info" role="alert">
      Aquí irá el contenido del escáner, por ejemplo, un formulario o un escáner de QR.
    </div>
  </div>

  <div id="" class="" data-aos="fade-down" data-aos-duration="2600">
    <div class="table-responsive">
   <table class="table table-striped">
  <thead class="bg-dark text-white">
    <tr>
      <th>Nombre</th>
      <th>Apellido</th>
      <th>Empresa</th>
      <th>Correo</th>
      <th>Teléfono</th>
    </tr>
  </thead>
  <tbody id="contactos-body" class="bg-white"></tbody>
</table>

    </div>
  </div>

  <div class="my-5 text-center" data-aos="fade-down" data-aos-duration="3000">
    <button id="loadMore" class="btn-custom">Mostrar Todos</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>


<script>
  AOS.init();

  window.addEventListener('DOMContentLoaded', async () => {
    const nombre = sessionStorage.getItem("nombre");
    const apellido = sessionStorage.getItem("apellido");
    const telefono = sessionStorage.getItem("telefono");
    const correo = sessionStorage.getItem("correo");
    const id = sessionStorage.getItem("id")

    // Poner el nombre en la bienvenida
    if (nombre) {
      document.getElementById("username").innerText = nombre;
    }

    if (!id) {
      document.getElementById("qr-container").innerText = "Datos incompletos";
      return;
    }

    const textoQR = `ID:${id}`; 

    try {
      const canvas = document.createElement('canvas');
      await QRCode.toCanvas(canvas, textoQR, {
        errorCorrectionLevel: 'L',
        margin: 1,
        scale: 6
      });
      document.getElementById('qr-container').appendChild(canvas);
    } catch (err) {
      console.error(err);
    }
  });

  const btnEscanear = document.getElementById('btnEscanear');
  const seccionEscaner = document.getElementById('seccionEscaner');
  const qrReader = document.getElementById('qr-reader');
  const qrResults = document.getElementById('qr-reader-results');

  const html5QrCode = new Html5Qrcode("qr-reader");

  btnEscanear.addEventListener('click', () => {
    seccionEscaner.style.display = "block";
    qrReader.style.display = "block";
    qrResults.innerText = "";

    html5QrCode.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      (decodedText, decodedResult) => {
        console.log("Código escaneado:", decodedText);
        qrResults.innerText = `✅ Código detectado: ${decodedText}`;

        const remitente_id = sessionStorage.getItem("id"); // el que escanea
        const destinatario_id = decodedText.replace("ID:", "").trim();


        fetch("/registrar-intercambio", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ remitente_id, destinatario_id })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              console.log(data.message);
            } else {
              console.warn(data.message);
            }
          })
          .catch(err => console.error("Error al registrar intercambio:", err));

        html5QrCode.stop().then(() => {
          console.log("Escaneo detenido");
          qrReader.style.display = "none";
        });
      },
      (errorMessage) => {
        console.warn(`Escaneo fallido: ${errorMessage}`);
      }
    );
  });

  async function cargarContactos() {
  const usuarioId = sessionStorage.getItem("id");
  const tbody = document.getElementById("contactos-body");

  if (!usuarioId) return;

  try {
    const res = await fetch(`/mis-contactos/${usuarioId}`);
    const contactos = await res.json();

    if (Array.isArray(contactos)) {
      contactos.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.nombre}</td>
          <td>${c.apellido}</td>
          <td>${c.empresa}</td>
          <td>${c.correo}</td>
          <td>${c.telefono}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  } catch (err) {
    console.error("Error al cargar contactos:", err);
  }
}

window.addEventListener('DOMContentLoaded', cargarContactos);

</script>